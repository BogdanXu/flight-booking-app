<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
          crossorigin="anonymous">
</head>
<body>

<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h2>Make payment for your booking</h2>
            <form id="paymentForm" th:action="@{/}"  method="post">

                <div class="mb-3">
                    <label for="sum" class="form-label">Sum</label>
                    <input type="number" required th:value="${sum}" class="form-control" id="sum">
                </div>
                <div class="mb-3">
                    <label for="bookingId" class="form-label">Booking Id</label>
                    <input type="text" required th:value="${bookingId}" class="form-control" id="bookingId">

                </div>
                <button type="button" id="paypalButton" class="btn btn-primary">Pay with PayPal</button>
                <button type="button" id="cardButton" class="btn btn-primary">Pay with Card</button>
            </form>
        </div>
    </div>
</div>

<!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"-->
<!--        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"-->
<!--        crossorigin="anonymous"></script>-->

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Obținem parametrii din URL
        var urlParams = new URLSearchParams(window.location.search);

        // Setăm valorile câmpurilor cu valorile parametrilor din URL
        var sum = urlParams.get('sum');
        var bookingId = urlParams.get('bookingId');

        if (sum) {
            document.getElementById('sum').value = sum;
        }

        // Setăm valoarea câmpului bookingId dacă parametrul bookingId este prezent
        if (bookingId) {
            document.getElementById('bookingId').value = bookingId;
        }
    });


    document.getElementById("paypalButton").addEventListener("click", function () {
        var sum = document.getElementById("sum").value;
        var bookingId = document.getElementById("bookingId").value;

        // Verificăm dacă sum/amount nu este gol
        if (sum.trim() === "") {
            alert("Sum is required.");
            return;
        }

        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/paypal/payment/create?sum=" + encodeURIComponent(sum) +"&bookingId=" + encodeURIComponent(bookingId), true);
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    // Redirect to the provided URL
                    window.location.href = JSON.parse(xhr.responseText).redirectUrl;
                } else {
                    // Handle error response
                    console.error("Error: " + xhr.status);
                    // Optionally, display an error message to the user
                }
            }
        };

        xhr.send();
    });



    // Codul pentru butonul de Card

document.getElementById("cardButton").addEventListener("click", function () {
    var sum = document.getElementById("sum").value;
    var bookingId = document.getElementById("bookingId").value;

    if (!sum || !bookingId) {
        alert("Both Sum and Booking ID are required.");
        return;
    }

fetch('/card/payment/create', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: `sum=${encodeURIComponent(sum)}&bookingId=${encodeURIComponent(bookingId)}`
})
.then(response => {
    if (response.redirected) {
        window.location.href = response.url; // Follow the redirect
    } else {
        return response.json(); // Handle JSON response
    }
})
.then(data => {
    if (data && data.status === "SUCCESS") {
        console.log('Payment processed successfully!');
    } else if (data && data.status === "FAILED") {
        alert("Payment failed: " + data.message);
    }
})
.catch((error) => {
    console.error('Error:', error);
    alert("Failed to process payment: " + error.message);
});
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>

</body>
</html>